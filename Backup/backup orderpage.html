@{
    Layout = "~/Views/Shared/_Adminlayout.cshtml";
    ViewData["Title"] = "Admin - Orders";

}

@model CustomModel

// string jsonResponse = await response.Content.ReadAsStringAsync();
// TempData["SuccessMessage"] = jsonResponse;
// return RedirectToAction("OrderPage", "Admin");

// Deserialize dữ liệu JSON thành danh sách các đối tượng OrderOffline
// string jsonResponse = await response.Content.ReadAsStringAsync();
// List<OrderOffline> orderOfflines = JsonConvert.DeserializeObject<List<OrderOffline>>(jsonResponse);

// // Sử dụng QuestPDF để tạo tài liệu PDF
// PdfDocument document = new PdfDocument();
// document.AddSection(section =>
// {
//     // Tạo nội dung của tài liệu PDF từ danh sách các đối tượng OrderOffline
//     foreach (var order in orderOfflines)
//     {
//         section.AddParagraph(order.Name);
//         section.AddParagraph(order.Phone);
//         // Thêm các thông tin khác tương ứng với đối tượng OrderOffline
//     }
// });

// // Tạo MemoryStream để lưu trữ tài liệu PDF
// MemoryStream stream = new MemoryStream();
// document.GeneratePdf(stream);

// // Đặt vị trí của stream về đầu để có thể đọc từ đầu
// stream.Position = 0;




// Trả về file PDF từ MemoryStream
// return File(stream, "application/pdf", "order.pdf");







<section id="main" style="position: absolute; ">


    <div class="row my-3">

        <div class="col-8">
            <input class="form-control" type="search" id="SearchLabel" placeholder="Tìm kiếm">
        </div>
        <div class="col">
            <a class="btn btn-outline-secondary" type="submit">
                <i class="fa-solid fa-magnifying-glass"></i>
            </a>
        </div>


        <div class="col text-end">
            <a class="btn btn-outline-secondary text-uppercase" data-bs-toggle="modal" data-bs-target="#orderModal">
                <i class="fa-solid fa-circle-plus" style="color: #74C0FC;"></i> Thêm
            </a>
        </div>

        <div class="col text-end">
            <a class="btn btn-outline-secondary text-uppercase" data-bs-toggle="modal" data-bs-target="#changeModal">
                <i class="fa-solid fa-circle-plus" style="color: #74C0FC;"></i> Sửa
            </a>
        </div>



        <div class="modal fade" id="orderModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <form asp-action="OrderOffline" asp-controller="Admin" method="post" enctype="multipart/form-data">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="exampleModalLabel">Thêm mới đơn hàng </h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body ">

                            <div class="row">
                                <div class="col-5">

                                    <div class="row mb-3">
                                        <div class="col">
                                            <input type="number" name="Phone" class="form-control" required
                                                placeholder="Số điện thoại* ">
                                        </div>
                                    </div>

                                    <div class="row mb-3">
                                        <div class="col">
                                            <input name="Name" class="form-control" required placeholder="Tên* ">
                                        </div>
                                    </div>

                                    <div class="row mb-3">
                                        <div class="col">
                                            <input name="OrderDate" type="date" class="form-control" required
                                                placeholder="Ngày đặt hàng* ">
                                        </div>
                                    </div>

                                    <div class="row mb-3">
                                        <div class="col">
                                            <input name="Location" type="text" class="form-control" required
                                                placeholder="Địa chỉ ">
                                        </div>
                                    </div>

                                    <div class="row mb-3">
                                        <div class="col">
                                            <input name="Note" type="text" class="form-control" placeholder="Ghi chú ">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-7">

                                    <fieldset class="">
                                        <legend>Choose order product</legend>

                                        <div class="row mb-3">
                                            <select id="Products" multiple>

                                                @foreach (var laptopOption in Model.Laptops)
                                                {
                                                    <option
                                                        value='@(laptopOption.Name + " + " + laptopOption.Price + " + " + laptopOption.LaptopId)'>
                                                        @laptopOption.Name
                                                    </option>
                                                }

                                            </select>


                                        </div>

                                        <table class="table table-striped table-bordered">
                                            <thead class="thead-dark">
                                                <tr>
                                                    <th>Tên sản phẩm</th>
                                                    <th>Giá</th>
                                                    <th>Số lượng</th>


                                                </tr>
                                            </thead>
                                            <tbody id="selectedLaptopsBody">
                                            </tbody>

                                        </table>
                                    </fieldset>
                                </div>
                            </div>

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </div>
                </div>
            </form>



        </div>


        @if (!string.IsNullOrEmpty(ViewBag.SuccessMessage))
        {
            <div class="alert alert-success alert-dismissible fade show m-3 " role="alert">
                @ViewBag.SuccessMessage
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        @if (!string.IsNullOrEmpty(ViewBag.ErrorMessage))
        {
            <div class="alert alert-danger alert-dismissible fade show m-3" role="alert">
                @ViewBag.ErrorMessage
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

    </div>



    @{
        var groupedOrders = Model.OrderOfflines
        .GroupBy(o => o.IdOrder)
        .OrderByDescending(g => g.Key);



        foreach (var orderGroup in groupedOrders)
        {
            var totalQuantity = orderGroup.Sum(o => o.Quantity);
            var totalAmount = orderGroup.Sum(o => o.Total ?? 0);
            var totalProductsCount = orderGroup.Sum(orderOffline => orderOffline.Quantity) + 2;
            var totalProducts = orderGroup.Sum(orderOffline => orderOffline.Quantity);

            <table class="table table-striped table-bordered mb-5">
                <thead class="thead-dark">
                    <tr class="" style="background-color: #bbe6d3">
                        <th class="col-3">Thông tin </th>
                        <th>Tên sản phẩm</th>
                        <th>Số lượng</th>
                        <th>Đơn giá</th>
                        <th>Tổng cộng</th>
                        @* <th>Thao tác</th> *@
                    </tr>
                </thead>
                <tbody>
                    @foreach (var orderOffline in orderGroup)
                    {
                        <tr>



                            @if (orderOffline == orderGroup.First())
                            {
                                <td rowspan="@totalProductsCount" style="vertical-align: middle;">
                                    Mã phiếu: @orderOffline.IdOrder
                                    <br>
                                    Tên: @orderOffline.Name
                                    <br>
                                    Phone: @orderOffline.Phone
                                    <br>
                                    Ngày: @orderOffline.OrderDate
                                    <br>
                                    Địa chỉ : @(orderOffline.Location != null ? orderOffline.Location : "Không")
                                    <br>
                                    Tình trạng: @orderOffline.StatusOrder
                                </td>
                            }
                            else
                            {

                            }

                            <td>@orderOffline.Products</td>
                            <td class="text-center">@orderOffline.Quantity</td>
                            <td>@orderOffline.Price</td>
                            <td class="text-center">@orderOffline.Total</td>


                        </tr>



                        <tr style="background-color:rgb(206, 238, 245)">

                            <td></td>
                            <td>Tổng SL: @totalQuantity</td>
                            <td></td>
                            <td>Thành tiền: @totalAmount</td>
                            @* <td></td> *@


                        </tr>

                        <tr style="background-color:rgb(206, 238, 245)">
                            <td class="text-center"> <!-- Sử dụng colspan để nút chiếm hết hàng -->
                                <form asp-action="YourAction" asp-controller="YourController" method="post"
                                    enctype="multipart/form-data">
                                    <!-- Your form content for the second button here -->
                                    <button class="btn btn-primary">Đặt hàng</button>
                                </form>

                            </td>
                            <td class="text-center">
                                <form asp-action="YourAction" asp-controller="YourController" method="post"
                                    enctype="multipart/form-data">
                                    <!-- Your form content for the third button here -->
                                    <button class="btn btn-success">Thanh toán</button>
                                </form>

                            </td>
                            <td class="text-center">
                                <form asp-action="YourAction" asp-controller="YourController" method="post"
                                    enctype="multipart/form-data">
                                    <!-- Your form content for the fourth button here -->
                                    <button class="btn btn-warning text-white">In hóa đơn</button>
                                </form>
                            </td>

                            <td class="text-center">
                                @if (orderOffline == orderGroup.First())
                                {
                                    <form id="deleteForm" asp-action="DeleteOrderOfflines" asp-controller="Admin" method="post"
                                        enctype="multipart/form-data">
                                        <input type="hidden" name="IdOrder" value="@orderOffline.IdOrder" />
                                        <button class="btn btn-danger" type="button" onclick="confirmDelete()">Hủy phiếu</button>
                                    </form>

                                }

                            </td>
                        </tr>
                    }
                </tbody>
            </table>




            <div class="modal fade" id="changeModal" tabindex="-1" aria-labelledby="exampleModalLabel2" aria-hidden="true">

                <form asp-action="ChangeOrderOffline" asp-controller="Admin" method="post" enctype="multipart/form-data">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5">Chỉnh sửa đơn hàng</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>

                            <div class="modal-body ">
                                <div class="row">
                                    <div class="col-5">

                                        <div class="row mb-3">
                                            <div class="col">
                                                <select name="IdOrder" id="selectedOrder" class="form-control orderId" required>
                                                    <option value="">-- Chọn mã phiếu --</option> <!-- Mục trống -->
                                                    @foreach (var orderOfflineGroup in Model.OrderOfflines.GroupBy(o =>
                                            o.IdOrder))
                                                    {
                                                        var idOrder = orderOfflineGroup.Key; // Lấy giá trị của thuộc tính IdOrder
                                                        <option value="@idOrder">Mã phiếu: @idOrder</option>
                                                    }
                                                </select>
                                            </div>
                                        </div>



                                        <div class="row mb-3">
                                            <div class="col">
                                                <input type="number" name="Phone" class="form-control phoneInput"
                                                    id="phoneInput" required placeholder="Số điện thoại* ">
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col">
                                                <input id="nameInput" name="Name" class="form-control" required
                                                    placeholder="Tên* ">
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col">
                                                <input name="OrderDate" type="date" id="orderDateInput" class="form-control"
                                                    required placeholder="Ngày đặt hàng* ">
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col">
                                                <input name="Note" id="noteInput" type="text" class="form-control"
                                                    placeholder="Ghi chú ">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-7">

                                        <fieldset class="">
                                            <legend>Choose order product</legend>

                                            <div class="row mb-3">
                                                <select name="Products" id="ChangeProduct" multiple>
                                                    @foreach (var laptopOption in Model.Laptops)
                                                    {
                                                        var laptopId = @laptopOption.LaptopId.ToString();
                                                        <option id="@laptopId"
                                                            value='@(laptopOption.Name + " + " + laptopOption.Price + " + " + laptopOption.LaptopId)'>
                                                            @laptopOption.Name
                                                        </option>
                                                    }

                                                </select>
                                            </div>

                                            <table class="table table-striped table-bordered">
                                                <thead class="thead-dark">
                                                    <tr>
                                                        <th>Tên sản phẩm</th>
                                                        <th>Giá</th>
                                                        <th>Số lượng</th>


                                                    </tr>
                                                </thead>
                                                <tbody id="selectedLaptopsBody2">
                                                </tbody>

                                            </table>
                                        </fieldset>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-primary">Save changes</button>
                            </div>
                        </div>
                    </div>


                </form>
            </div>








        }
    }






</section>

<style>
    #main {
        position: absolute;
        top: 69px;
        /* Khoảng cách từ trên xuống */
        bottom: 0;
        /* Chiều cao sẽ chiếm đến cuối trang */
        left: 0;
        /* Khoảng cách từ bên trái sang */
        right: 0;
        /* Khoảng cách từ bên phải sang */
        padding-left: 10px;
        font-family: var(--bs-font-monospace);
        color: #012970;
        text-overflow: ellipsis;
        text-decoration: none;
    }
</style>

<script>
    $(document).ready(function () {
        $('#editButton').on('click', function () {
            var idOrder = $(this).data('id-order');
            $('#orderId').val(idOrder);
        });
    });



</script>

<script>
    function confirmDelete() {
        if (confirm("Bạn có chắc chắn muốn hủy phiếu không?")) {
            document.getElementById("deleteForm").submit();
        }
    }
</script>



<script>
    new MultiSelectTag('Products', {
        rounded: true,
        shadow: true,
        placeholder: 'Search',
        tagColor: {
            textColor: '#327b2c',
            borderColor: '#92e681',
            bgColor: '#eaffe6',
        },
        onChange: function (values) {
            console.log(values);

            var selectedLaptopsBody = document.getElementById('selectedLaptopsBody');

            selectedLaptopsBody.innerHTML = ''; // Xóa các dòng dữ liệu cũ trong bảng
            values.forEach(function (laptop) {

                var parts = laptop.value.split('+');
                var name = parts[0].trim();
                var price = parseFloat(parts[1].trim());
                var laptopId = parseInt(parts[2].trim());
                console.log("Name:", name, "Price:", price, "LaptopId:", laptopId);

                var row = '<tr>';
                row += '<td>' + '<input   name="Products[]" readonly  value="' + name + '">' + '</td>';  // Tên sản phẩm
                // Thêm các cột khác tương ứng với thông tin sản phẩm, ví dụ: giá, số lượng, tổng, thao tác
                row += '<td>' + '<input   name="Price[]" readonly  value="' + price + '">' + '</td>'; // Giá
                row += '<td><input type="number" name="Quantity[]" class="quantity-input" value="1" min="1" autocomplete="off"></td>'; // Số lượng
                row += '<td style="display:none;" >' + '<input   name="LaptopId[]" style="display:none;" readonly  value="' + laptopId + '">' + '</td>'; // Id
                row += '</tr>';
                selectedLaptopsBody.innerHTML += row;
            });
        }
    });


    new MultiSelectTag('ChangeProduct',
        {
            rounded: true,
            shadow: true,
            placeholder: 'Search',
            tagColor:
            {
                textColor: '#327b2c',
                borderColor: '#92e681',
                bgColor: '#eaffe6',
            },
            onChange: function (values) {
                console.log(values);

                var selectedLaptopsBody2 = document.getElementById('selectedLaptopsBody2');

                selectedLaptopsBody2.innerHTML = ''; // Xóa các dòng dữ liệu cũ trong bảng
                values.forEach(function (laptop) {

                    var parts = laptop.value.split('+');
                    var name = parts[0].trim();
                    var price = parseFloat(parts[1].trim());
                    var laptopId = parseInt(parts[2].trim());
                    console.log("Name:", name, "Price:", price, "LaptopId:", laptopId);

                    var row = '<tr>';
                    row += '<td>' + '<input   name="Products[]" readonly  value="' + name + '">' + '</td>';  // Tên sản phẩm
                    // Thêm các cột khác tương ứng với thông tin sản phẩm, ví dụ: giá, số lượng, tổng, thao tác
                    row += '<td>' + '<input   name="Price[]" readonly  value="' + price + '">' + '</td>'; // Giá
                    row += '<td><input type="number" name="Quantity[]" class="quantity-input" value="1" min="1" autocomplete="off"></td>'; // Số lượng
                    row += '<td style="display:none;" >' + '<input   name="LaptopId[]" style="display:none;" readonly  value="' + laptopId + '">' + '</td>'; // Id
                    row += '</tr>';
                    selectedLaptopsBody2.innerHTML += row;
                });

            }
        });







</script>

<script>
    $(document).ready(function () {
        $('#orderIdSelect').change(function () {
            var selectedOrderId = $(this).val();
            console.log("Giá trị đã chọn: " + selectedOrderId);
        });
    });

</script>

<script>
    $(document).ready(function () {
        $('#selectedOrder').on('change', function () {
            var selectedOrderId = $(this).val(); // Lấy giá trị idorder đã chọn

            // Gửi AJAX request để gọi API và lấy dữ liệu dựa trên idorder đã chọn
            $.ajax({
                url: 'http://localhost:4000/api/Laptop/GetDetailOrderOfflines',
                type: 'POST',
                data: { IdOrder: selectedOrderId }, // Truyền tham số IdOrder vào API
                success: function (response) {
                    console.log(response); // Log dữ liệu trả về ra console

                    if (response.length > 0) {
                        // Lấy giá trị phone từ dữ liệu response
                        var phoneValue = response[0].phone;

                        // Đặt giá trị của input có id là "phoneInput" bằng giá trị phone từ response
                        $('#phoneInput').val(phoneValue);

                        var nameValue = response[0].name;
                        $('#nameInput').val(nameValue);

                        // Chuyển đổi định dạng ngày từ "yyyy-MM-ddTHH:mm:ss" sang "yyyy-MM-dd"
                        var orderDateValue = response[0].orderDate.split('T')[0];
                        $('#orderDateInput').val(orderDateValue);

                        var noteValue = response[0].note;
                        $('#noteInput').val(noteValue);

                        var selectedValues = response.map(function (item) {
                            return item.laptopId.toString(); // Chuyển đổi thành chuỗi vì giá trị của option là chuỗi
                        });
                        console.log(selectedValues);

                        selectedValues.forEach(function (value) {
                            $("#ChangeProduct option[id='" + value + "']").prop("selected", true); // Sử dụng thuộc tính id để so sánh
                        });

                    } else {
                        // Nếu không có dữ liệu, đặt giá trị của input là rỗng
                        $('#phoneInput').val('');
                    }
                },
                error: function (xhr, status, error) {
                    console.error(error); // Xử lý lỗi nếu có
                }
            });
        });
    });
</script>




<link rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/habibmhamadi/multi-select-tag@2.0.1/dist/css/multi-select-tag.css">

<script src="https://cdn.jsdelivr.net/gh/habibmhamadi/multi-select-tag@2.0.1/dist/js/multi-select-tag.js"></script>