@{
    Layout = "~/Views/Shared/_Adminlayout.cshtml";
    ViewData["Title"] = "Admin - Orders";
}

@model CustomModel

<section id="main" style="position: absolute; ">
    <div class="row my-3">

        <form class="col-8" action="" enctype="multipart/form-data" method="get">
        <div class="input-group">
            <input class="form-control" name="searchvalue" type="search" id="SearchLabel" placeholder="Tìm kiếm">
            <button class="btn btn-outline-secondary" type="submit">
                <i class="fa-solid fa-magnifying-glass"></i>
            </button>
        </div>
    </form>


        <div class="col text-end">
            <a class="btn btn-outline-secondary text-uppercase" data-bs-toggle="modal" data-bs-target="#orderModal">
                <i class="fa-solid fa-circle-plus" style="color: #74C0FC;"></i> Thêm
            </a>
        </div>

        <div class="col text-end">
            <a class="btn btn-outline-secondary text-uppercase" data-bs-toggle="modal" data-bs-target="#changeModal">
                <i class="fa-solid fa-circle-plus" style="color: #74C0FC;"></i> Sửa
            </a>
        </div>



        <div class="modal fade" id="orderModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            
            <form asp-action="OrderOffline" asp-controller="Admin" method="post" enctype="multipart/form-data">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="exampleModalLabel">Thêm mới đơn hàng </h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body ">

                            <div class="row">
                                <div class="col-5">

                                    <div class="row mb-3">
                                        <div class="col">
                                            <input type="number" name="Phone" class="form-control" required
                                                placeholder="Số điện thoại* ">
                                        </div>
                                    </div>

                                    <div class="row mb-3">
                                        <div class="col">
                                            <input name="Name" class="form-control" required placeholder="Tên* ">
                                        </div>
                                    </div>

                                    <div class="row mb-3">
                                        <div class="col">
                                            <input name="OrderDate" type="date" class="form-control" required
                                                placeholder="Ngày đặt hàng* ">
                                        </div>
                                    </div>

                                    <div class="row mb-3">
                                        <div class="col">
                                            <input name="Location" type="text" class="form-control" required
                                                placeholder="Địa chỉ ">
                                        </div>
                                    </div>

                                    <div class="row mb-3">
                                        <div class="col">
                                            <input name="Note" type="text" class="form-control" placeholder="Ghi chú ">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-7">

                                    <fieldset class="">
                                        <legend>Choose order product</legend>

                                        <div class="row mb-3">
                                            <select id="Products" multiple>

                                                @foreach (var laptopOption in Model.Laptops)
                                                {
                                                    <option
                                                        value='@(laptopOption.Name + " + " + laptopOption.Price + " + " + laptopOption.LaptopId)'>
                                                        @laptopOption.Name
                                                    </option>
                                                }

                                            </select>


                                        </div>

                                        <table class="table table-striped table-bordered">
                                            <thead class="thead-dark">
                                                <tr>
                                                    <th>Tên sản phẩm</th>
                                                    <th>Giá</th>
                                                    <th>Số lượng</th>


                                                </tr>
                                            </thead>
                                            <tbody id="selectedLaptopsBody">
                                            </tbody>

                                        </table>
                                    </fieldset>
                                </div>
                            </div>

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </div>
                </div>
            </form>



        </div>

        <div class="container">
            @if (!string.IsNullOrEmpty(ViewBag.SuccessMessage))
            {
                <div class="alert alert-success alert-dismissible fade show m-3 " role="alert">
                    @ViewBag.SuccessMessage
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }

            @if (!string.IsNullOrEmpty(ViewBag.ErrorMessage))
            {
                <div class="alert alert-danger alert-dismissible fade show m-3" role="alert">
                    @ViewBag.ErrorMessage
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }

        </div>



    </div>

    @{

        var groupedOrders = Model.OrderOfflines
        .GroupBy(o => o.IdOrder)
        .OrderByDescending(g => g.Key);

        @* var groupedOrders = Model.OrderOfflines
        .GroupBy(o => o.IdOrder)
        .OrderBy(g => g.Key)
        .Take(2); // Chỉ lấy ra 2 nhóm đầu tiên *@

        foreach (var orderGroup in groupedOrders)
        {
            var totalQuantity = orderGroup.Sum(o => o.Quantity);
            var totalAmount = orderGroup.Sum(o => o.Total ?? 0);
            var totalProductsCount = orderGroup.Sum(orderOffline => orderOffline.Quantity) + totalQuantity + 2;
            var totalProducts = orderGroup.Sum(orderOffline => orderOffline.Quantity);

            <table class="table table-striped table-bordered mb-4">
                <thead class="thead-dark">
                    <tr style="background-color: #bbe6d3">
                        <th class="col-3">Thông tin </th>
                        <th>Tên sản phẩm</th>
                        <th>Số lượng</th>
                        <th>Đơn giá</th>
                        <th>Tổng cộng</th>
                    </tr>
                </thead>
                <tbody id="tbodysearch">
                    @foreach (var orderOffline in orderGroup)
                    {

                        <tr>
                            @if (orderOffline == orderGroup.First())
                            {
                                var phoneconvert = "+84 " + @orderOffline.Phone;
                                <td rowspan="@totalProductsCount" style="vertical-align: middle;">
                                    Mã phiếu: @orderOffline.IdOrder
                                    <br>
                                    Tên: @orderOffline.Name
                                    <br>
                                    Phone: @phoneconvert
                                    <br>
                                    Ngày: @(orderOffline.OrderDate.HasValue ? orderOffline.OrderDate.Value.ToShortDateString() : "Không có ngày")
                                    <br>
                                    Địa chỉ: @(orderOffline.Location != null ? orderOffline.Location : "Không")
                                    <br>
                                    Tình trạng: @orderOffline.StatusOrder
                                    <br>
                                    Ghi chú: @(orderOffline.Note != null ? orderOffline.Note : "Không") 
                                </td>
                            }
                        </tr>

                        <td>@orderOffline.Products</td>
                        <td class="text-center">@orderOffline.Quantity</td>
                        <td>@orderOffline.Price</td>
                        <td class="text-center">@orderOffline.Total</td>


                    }

                    @foreach (var orderOffline in orderGroup)
                    {
                        @if (orderOffline == orderGroup.First())
                        {
                            <tr style="background-color:rgb(206, 238, 245)">

                                <td></td>
                                <td>Tổng SL: @totalQuantity</td>
                                <td></td>
                                <td>Thành tiền: @totalAmount</td>
                            </tr>
                        }


                        @if (orderOffline == orderGroup.First())
                        {
                            <tr style="background-color:rgb(206, 238, 245)">

                                <td class="text-center">
                                    <form asp-action="ChangeStatusOrder" asp-controller="Admin" id="changeStatusForm" method="post"
                                        enctype="multipart/form-data">
                                        <input type="hidden" name="IdOrder" value="@orderOffline.IdOrder" />
                                        <button class="btn btn-primary" type="submit"
                                            onclick="ChangeStatusOrder('@orderOffline.IdOrder')">
                                            Đặt hàng
                                        </button>
                                    </form>
                                </td>

                                <td class="text-center">
                                    <form asp-action="YourAction" asp-controller="YourController" method="post"
                                        enctype="multipart/form-data">

                                        <button class="btn btn-success">Thanh toán</button>
                                    </form>

                                </td>
                                <td class="text-center">
                                        <button data-bs-toggle="modal" data-bs-target="#billModal" class="btn btn-warning text-white ">In hóa đơn</button>
                                </td>

                                <td class="text-center">
                                    <form id="deleteForm" method="post" enctype="multipart/form-data">
                                        <input type="hidden" name="IdOrder" value="@orderOffline.IdOrder" />
                                        <button class="btn btn-danger" type="button" onclick="confirmDelete('@orderOffline.IdOrder')">
                                            Hủy phiếu
                                        </button>


                                    </form>

                                </td>
                            </tr>


                            <div class="modal fade" id="billModal" tabindex="-1" aria-labelledby="exampleModalLabel3" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                     <form asp-action="CreatePdf" asp-controller="Admin" method="post" enctype="multipart/form-data">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="exampleModalLabel3">Xác nhận in hóa đơn </h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body" id="modalBodyContent">
                                                <input name="IdOrder" value="@orderOffline.IdOrder" />
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Thoát</button>
                                            <button type="submit" class="btn btn-primary" id="printButton">In hóa đơn</button>
                                            </div>
                                            
                                        </div>
                                     </form>
                                    
                                </div>
                            </div>

                           

                      

                        }

                    }

                </tbody>
            </table>

            <div class="modal fade" id="changeModal" tabindex="-1" aria-labelledby="exampleModalLabel2" aria-hidden="true">

                <form asp-action="ChangeOrderOffline" asp-controller="Admin" method="post" enctype="multipart/form-data">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5">Chỉnh sửa đơn hàng</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>

                            <div class="modal-body ">
                                <div class="row">
                                    <div class="col-5">

                                        <div class="row mb-3">
                                            <div class="col">
                                                <select name="IdOrder" id="selectedOrder" class="form-control orderId" required>
                                                    <option value="">-- Chọn mã phiếu --</option> <!-- Mục trống -->
                                                    @foreach (var orderOfflineGroup in Model.OrderOfflines.GroupBy(o =>
                                            o.IdOrder))
                                                    {
                                                        var idOrder = orderOfflineGroup.Key; // Lấy giá trị của thuộc tính IdOrder
                                                        <option value="@idOrder">Mã phiếu: @idOrder</option>
                                                    }
                                                </select>
                                            </div>
                                        </div>



                                        <div class="row mb-3">
                                            <div class="col">
                                                <input type="number" name="Phone" class="form-control phoneInput"
                                                    id="phoneInput" required placeholder="Số điện thoại* ">
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col">
                                                <input id="nameInput" name="Name" class="form-control" required
                                                    placeholder="Tên* ">
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col">
                                                <input name="OrderDate" type="date" id="orderDateInput" class="form-control"
                                                    required placeholder="Ngày đặt hàng* ">
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col">
                                                <input name="Location" type="text" class="form-control" required
                                                    placeholder="Địa chỉ ">
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col">
                                                <input name="Note" id="noteInput" type="text" class="form-control"
                                                    placeholder="Ghi chú ">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-7">

                                        <fieldset class="">
                                            <legend>Choose order product</legend>

                                            <div class="row mb-3">
                                                <select id="ChangeProduct" multiple>
                                                    @foreach (var laptopOption in Model.Laptops)
                                                    {
                                                        var laptopId = @laptopOption.LaptopId.ToString();
                                                        <option id="@laptopId"
                                                            value='@(laptopOption.Name + " + " + laptopOption.Price + " + " + laptopOption.LaptopId)'>
                                                            @laptopOption.Name
                                                        </option>
                                                    }

                                                </select>
                                            </div>

                                            <table class="table table-striped table-bordered">
                                                <thead class="thead-dark">
                                                    <tr>
                                                        <th>Tên sản phẩm</th>
                                                        <th>Giá</th>
                                                        <th>Số lượng</th>


                                                    </tr>
                                                </thead>
                                                <tbody id="selectedLaptopsBody2">
                                                </tbody>

                                            </table>
                                        </fieldset>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-primary">Save changes</button>
                            </div>
                        </div>
                    </div>


                </form>
            </div>

          
        }
    }


    <div class="row ">
     <form asp-action="OrderPage" asp-controller="Admin" method="post">
         <nav aria-label="Page navigation example">
             <ul class="pagination justify-content-center">
                 @if (Model.Page > 1)
                 {
                 <li class="page-item">
                     <a class="page-link" asp-action="OrderPage" asp-controller="Admin"
                         asp-route-page="@(Model.Page - 1)" asp-route-take="@Model.PageSize" aria-label="Previous">
                         <span aria-hidden="true">&laquo;</span>
                         <span class="sr-only">Previous</span>
                     </a>
                 </li>
                 }

                 @for (var i = 1; i < Model.TotalPages; i++) { <li class="page-item @(i == Model.Page ? " active" : ""
                     )">
                     <a class="page-link" asp-action="OrderPage" asp-controller="Admin" asp-route-page="@i"
                         asp-route-take="@Model.PageSize">@i</a>
                     </li>
                     }

                     @if (Model.Page < Model.TotalPages) { <li class="page-item">
                         <a class="page-link" asp-action="OrderPage" asp-controller="Admin"
                             asp-route-page="@(Model.Page + 1)" asp-route-take="@Model.PageSize" aria-label="Next">
                             <span aria-hidden="true">&raquo;</span>
                             <span class="sr-only">Next</span>
                         </a>
                         </li>
                         }
             </ul>
         </nav>
     </form>

 </div>

</section>




<style>
    #main {
        position: absolute;
        top: 69px;
        /* Khoảng cách từ trên xuống */
        bottom: 0;
        /* Chiều cao sẽ chiếm đến cuối trang */
        left: 0;
        /* Khoảng cách từ bên trái sang */
        right: 0;
        /* Khoảng cách từ bên phải sang */
        padding-left: 10px;
        font-family: var(--bs-font-monospace);
        color: #012970;
        text-overflow: ellipsis;
        text-decoration: none;
    }
</style>

<script>
    function ChangeStatusOrder() {
        var idOrderInput = document.querySelector("#changeStatusForm [name='IdOrder']");
        var idOrderValue = idOrderInput.value;
        console.log(idOrderValue);
        return true; // Đảm bảo form được submit
    }
</script>

<script>
    $(document).ready(function () {
        $('#editButton').on('click', function () {
            var idOrder = $(this).data('id-order');
            $('#orderId').val(idOrder);
        });
    });



</script>

<script>
    function confirmDelete(idOrder) {
        if (confirm("Bạn có chắc chắn muốn xóa phiếu này không?")) {
            // Tạo một đối tượng XMLHttpRequest
            var xhr = new XMLHttpRequest();

            // Định nghĩa hàm callback để xử lý phản hồi từ server
            xhr.onreadystatechange = function () {
                if (xhr.readyState == XMLHttpRequest.DONE) {
                    if (xhr.status == 200) {

                        // Xóa thành công, chuyển hướng lại trang "OrderPage"
                        window.location.href = "/Admin/OrderPage";
                    } else {
                        // Xử lý lỗi từ server
                        alert("Không thể xóa phiếu. Vui lòng thử lại sau.");
                    }
                }
            };

            // Mở một yêu cầu DELETE đến controller với IdOrder được truyền vào
            xhr.open("DELETE", "/Admin/DeleteOrderOfflines?IdOrder=" + idOrder, true);

            // Gửi yêu cầu
            xhr.send();
        }
    }
</script>

<script>
    new MultiSelectTag('Products', {
        rounded: true,
        shadow: true,
        placeholder: 'Search',
        tagColor: {
            textColor: '#327b2c',
            borderColor: '#92e681',
            bgColor: '#eaffe6',
        },
        onChange: function (values) {
            console.log(values);

            var selectedLaptopsBody = document.getElementById('selectedLaptopsBody');

            selectedLaptopsBody.innerHTML = ''; // Xóa các dòng dữ liệu cũ trong bảng
            values.forEach(function (laptop) {

                var parts = laptop.value.split('+');
                var name = parts[0].trim();
                var price = parseFloat(parts[1].trim());
                var laptopId = parseInt(parts[2].trim());
                console.log("Name:", name, "Price:", price, "LaptopId:", laptopId);

                var row = '<tr>';
                row += '<td>' + '<input   name="Products[]" readonly  value="' + name + '">' + '</td>';  // Tên sản phẩm
                // Thêm các cột khác tương ứng với thông tin sản phẩm, ví dụ: giá, số lượng, tổng, thao tác
                row += '<td>' + '<input   name="Price[]" readonly  value="' + price + '">' + '</td>'; // Giá
                row += '<td><input type="number" name="Quantity[]" class="quantity-input" value="1" min="1" autocomplete="off"></td>'; // Số lượng
                row += '<td style="display:none;" >' + '<input   name="LaptopId[]" style="display:none;" readonly  value="' + laptopId + '">' + '</td>'; // Id
                row += '</tr>';
                selectedLaptopsBody.innerHTML += row;
            });
        }
    });


    new MultiSelectTag('ChangeProduct', {
        rounded: true,
        shadow: true,
        placeholder: 'Search',
        tagColor: {
            textColor: '#327b2c',
            borderColor: '#92e681',
            bgColor: '#eaffe6',
        },
        onChange: function (values) {
            console.log(values);

            var selectedLaptopsBody2 = document.getElementById('selectedLaptopsBody2');

            selectedLaptopsBody2.innerHTML = ''; // Xóa các dòng dữ liệu cũ trong bảng
            values.forEach(function (laptop) {

                var parts = laptop.value.split('+');
                var name = parts[0].trim();
                var price = parseFloat(parts[1].trim());
                var laptopId = parseInt(parts[2].trim());
                console.log("Name:", name, "Price:", price, "LaptopId:", laptopId);

                var row = '<tr>';
                row += '<td>' + '<input   name="Products[]" readonly  value="' + name + '">' + '</td>';  // Tên sản phẩm
                // Thêm các cột khác tương ứng với thông tin sản phẩm, ví dụ: giá, số lượng, tổng, thao tác
                row += '<td>' + '<input   name="Price[]" readonly  value="' + price + '">' + '</td>'; // Giá
                row += '<td><input type="number" name="Quantity[]" class="quantity-input" value="1" min="1" autocomplete="off"></td>'; // Số lượng
                row += '<td style="display:none;" >' + '<input   name="LaptopId[]" style="display:none;" readonly  value="' + laptopId + '">' + '</td>'; // Id
                row += '</tr>';
                selectedLaptopsBody2.innerHTML += row;
            });
        }
    });


    @* new MultiSelectTag('ChangeProduct',
        {
        rounded: true,
        shadow: true,
        placeholder: 'Search',
        tagColor:
        {
        textColor: '#327b2c',
        borderColor: '#92e681',
        bgColor: '#eaffe6',
        },
        onChange: function (values) {
        console.log(values);

        var selectedLaptopsBody2 = document.getElementById('selectedLaptopsBody2');

        selectedLaptopsBody2.innerHTML = ''; // Xóa các dòng dữ liệu cũ trong bảng
        values.forEach(function (laptop) {

        var parts = laptop.value.split('+');
        var name = parts[0].trim();
        var price = parseFloat(parts[1].trim());
        var laptopId = parseInt(parts[2].trim());
        console.log("Name:", name, "Price:", price, "LaptopId:", laptopId);

        var row = '<tr>';
        row += '<td>' + '<input   name="Products[]" readonly  value="' + name + '">' + '</td>';  // Tên sản phẩm
        // Thêm các cột khác tương ứng với thông tin sản phẩm, ví dụ: giá, số lượng, tổng, thao tác
        row += '<td>' + '<input   name="Price[]" readonly  value="' + price + '">' + '</td>'; // Giá
        row += '<td><input type="number" name="Quantity[]" class="quantity-input" value="1" min="1" autocomplete="off"></td>'; // Số lượng
        row += '<td style="display:none;" >' + '<input   name="LaptopId[]" style="display:none;" readonly  value="' + laptopId + '">' + '</td>'; // Id
        row += '</tr>';
        selectedLaptopsBody2.innerHTML += row;
        });

        }
        }); *@







</script>

<script>
        $(document).ready(function () {
            $('#orderIdSelect').change(function () {
                var selectedOrderId = $(this).val();
                console.log("Giá trị đã chọn: " + selectedOrderId);
            });
        });

</script>

<script>
    $(document).ready(function () {
        $('#selectedOrder').on('change', function () {
            var selectedOrderId = $(this).val(); // Lấy giá trị idorder đã chọn

            // Gửi AJAX request để gọi API và lấy dữ liệu dựa trên idorder đã chọn
            $.ajax({
                url: 'http://localhost:4000/api/Laptop/GetDetailOrderOfflines',
                type: 'POST',
                data: { IdOrder: selectedOrderId }, // Truyền tham số IdOrder vào API
                success: function (response) {
                    console.log(response); // Log dữ liệu trả về ra console

                    if (response.length > 0) {
                        // Lấy giá trị phone từ dữ liệu response
                        var phoneValue = response[0].phone;

                        // Đặt giá trị của input có id là "phoneInput" bằng giá trị phone từ response
                        $('#phoneInput').val(phoneValue);

                        var nameValue = response[0].name;
                        $('#nameInput').val(nameValue);

                        // Chuyển đổi định dạng ngày từ "yyyy-MM-ddTHH:mm:ss" sang "yyyy-MM-dd"
                        var orderDateValue = response[0].orderDate.split('T')[0];
                        $('#orderDateInput').val(orderDateValue);

                        var noteValue = response[0].note;
                        $('#noteInput').val(noteValue);

                        var selectedValues = response.map(function (item) {
                            return item.laptopId.toString(); // Chuyển đổi thành chuỗi vì giá trị của option là chuỗi
                        });
                        console.log(selectedValues);

                        selectedValues.forEach(function (value) {
                            $("#ChangeProduct option[id='" + value + "']").prop("selected", true); // Sử dụng thuộc tính id để so sánh
                        });

                    } else {
                        // Nếu không có dữ liệu, đặt giá trị của input là rỗng
                        $('#phoneInput').val('');
                    }
                },
                error: function (xhr, status, error) {
                    console.error(error); // Xử lý lỗi nếu có
                }
            });
        });
    });
</script>




<link rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/habibmhamadi/multi-select-tag@2.0.1/dist/css/multi-select-tag.css">

<script src="https://cdn.jsdelivr.net/gh/habibmhamadi/multi-select-tag@2.0.1/dist/js/multi-select-tag.js"></script>